// TORP Platform Database Schema
// PostgreSQL database using Prisma ORM

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// User Models
// ============================================================================

model User {
  id           String    @id @default(uuid())
  email        String    @unique
  passwordHash String?   @map("password_hash")
  authProvider String?   @map("auth_provider") // 'local', 'google', 'auth0'
  role         UserRole  @default(CONSUMER)
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  deletedAt    DateTime? @map("deleted_at")

  // Relations
  profile                 UserProfile?
  companyProfile          CompanyProfile?
  documents               Document[]
  devis                   Devis[]
  torpScores              TORPScore[]
  comparisons             Comparison[]
  subscriptions           Subscription[]
  payments                Payment[]
  analyticsEvents         AnalyticsEvent[]
  projectCCFs             ProjectCCF[]
  chatMessages            ChatMessage[]
  complementaryDocuments  ComplementaryDocument[]
  recommendationFeedbacks RecommendationFeedback[]
  buildingProfiles        BuildingProfile[]
  buildingDocuments       BuildingDocument[]

  @@index([email])
  @@map("users")
}

enum UserRole {
  CONSUMER
  PROFESSIONAL
  ADMIN

  @@map("user_role")
}

model UserProfile {
  id          String   @id @default(uuid())
  userId      String   @unique @map("user_id")
  firstName   String?  @map("first_name")
  lastName    String?  @map("last_name")
  phone       String?
  address     Json?
  preferences Json?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

model CompanyProfile {
  id                     String   @id @default(uuid())
  userId                 String   @unique @map("user_id")
  companyName            String   @map("company_name")
  siret                  String?  @unique
  activitySectors        String[] @map("activity_sectors")
  certifications         String[]
  torpCertificationLevel String?  @map("torp_certification_level")
  insurancePolicy        Json?    @map("insurance_policy")
  createdAt              DateTime @default(now()) @map("created_at")
  updatedAt              DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("company_profiles")
}

// ============================================================================
// Document Models
// ============================================================================

model Document {
  id           String         @id @default(uuid())
  userId       String         @map("user_id")
  fileName     String         @map("file_name")
  fileType     String         @map("file_type")
  fileSize     Int            @map("file_size")
  fileUrl      String         @map("file_url")
  uploadStatus DocumentStatus @default(PENDING) @map("upload_status")
  ocrStatus    DocumentStatus @default(PENDING) @map("ocr_status")
  createdAt    DateTime       @default(now()) @map("created_at")
  updatedAt    DateTime       @updatedAt @map("updated_at")

  // Relations
  user  User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  devis Devis[]

  @@index([userId])
  @@map("documents")
}

enum DocumentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED

  @@map("document_status")
}

// ============================================================================
// Devis (Quote) Models
// ============================================================================

model Devis {
  id               String         @id @default(uuid())
  documentId       String         @map("document_id")
  userId           String         @map("user_id")
  extractedData    Json           @map("extracted_data")
  parsedData       Json?          @map("parsed_data")
  enrichedData     Json?          @map("enriched_data")
  validationStatus DocumentStatus @default(PENDING) @map("validation_status")
  validationErrors Json?          @map("validation_errors")
  projectType      String?        @map("project_type")
  tradeType        String?        @map("trade_type")
  totalAmount      Decimal        @map("total_amount") @db.Decimal(12, 2)
  createdAt        DateTime       @default(now()) @map("created_at")
  updatedAt        DateTime       @updatedAt @map("updated_at")

  // Relations
  document                Document                 @relation(fields: [documentId], references: [id], onDelete: Cascade)
  user                    User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  torpScores              TORPScore[]
  gptAnalyses             GPTAnalysis[]
  projectCCF              ProjectCCF?
  chatMessages            ChatMessage[]
  complementaryDocuments  ComplementaryDocument[]
  recommendationFeedbacks RecommendationFeedback[]

  @@index([userId])
  @@index([documentId])
  @@map("devis")
}

// ============================================================================
// TORP Score Models
// ============================================================================

model TORPScore {
  id                String   @id @default(uuid())
  devisId           String   @map("devis_id")
  scoreValue        Decimal  @map("score_value") @db.Decimal(5, 2)
  scoreGrade        String   @map("score_grade")
  confidenceLevel   Decimal  @map("confidence_level") @db.Decimal(5, 2)
  breakdown         Json
  alerts            Json
  recommendations   Json
  regionalBenchmark Json?    @map("regional_benchmark")
  algorithmVersion  String   @map("algorithm_version")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  devis  Devis  @relation(fields: [devisId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @map("user_id")

  @@index([devisId])
  @@map("torp_scores")
}

// ============================================================================
// Comparison Models
// ============================================================================

model Comparison {
  id               String   @id @default(uuid())
  userId           String   @map("user_id")
  devisIds         String[] @map("devis_ids")
  comparisonData   Json     @map("comparison_data")
  aiRecommendation Json?    @map("ai_recommendation")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("comparisons")
}

// ============================================================================
// Subscription & Payment Models
// ============================================================================

model Subscription {
  id                   String             @id @default(uuid())
  userId               String             @map("user_id")
  planType             PlanType           @map("plan_type")
  status               SubscriptionStatus
  currentPeriodStart   DateTime           @map("current_period_start")
  currentPeriodEnd     DateTime           @map("current_period_end")
  cancelAtPeriodEnd    Boolean            @default(false) @map("cancel_at_period_end")
  stripeSubscriptionId String?            @unique @map("stripe_subscription_id")
  stripeCustomerId     String?            @map("stripe_customer_id")
  createdAt            DateTime           @default(now()) @map("created_at")
  updatedAt            DateTime           @updatedAt @map("updated_at")

  // Relations
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments Payment[]

  @@index([userId])
  @@map("subscriptions")
}

enum PlanType {
  FREE
  PREMIUM_CONSUMER
  PRO
  ENTERPRISE

  @@map("plan_type")
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  TRIALING

  @@map("subscription_status")
}

model Payment {
  id                    String        @id @default(uuid())
  userId                String        @map("user_id")
  subscriptionId        String?       @map("subscription_id")
  amount                Decimal       @db.Decimal(10, 2)
  currency              String        @default("EUR")
  status                PaymentStatus
  stripePaymentIntentId String?       @unique @map("stripe_payment_intent_id")
  paymentMethod         String?       @map("payment_method")
  metadata              Json?
  createdAt             DateTime      @default(now()) @map("created_at")
  updatedAt             DateTime      @updatedAt @map("updated_at")

  // Relations
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscription Subscription? @relation(fields: [subscriptionId], references: [id])

  @@index([userId])
  @@map("payments")
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  REFUNDED

  @@map("payment_status")
}

// ============================================================================
// Analytics Models
// ============================================================================

model AnalyticsEvent {
  id            String        @id @default(uuid())
  userId        String?       @map("user_id")
  eventType     String        @map("event_type")
  eventCategory EventCategory @map("event_category")
  properties    Json
  sessionId     String?       @map("session_id")
  createdAt     DateTime      @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([createdAt])
  @@map("analytics_events")
}

enum EventCategory {
  ENGAGEMENT
  CONVERSION
  FEATURE_USAGE

  @@map("event_category")
}

// ============================================================================
// CCF (Cahier des Charges Fonctionnel) Models
// ============================================================================

model ProjectCCF {
  id                 String   @id @default(uuid())
  userId             String   @map("user_id")
  devisId            String?  @unique @map("devis_id")
  projectType        String   @map("project_type")
  projectTitle       String?  @map("project_title")
  projectDescription String?  @map("project_description")
  address            String?
  postalCode         String?  @map("postal_code")
  city               String?
  region             String?
  coordinates        Json?
  buildingData       Json?    @map("building_data")
  urbanismData       Json?    @map("urbanism_data")
  energyData         Json?    @map("energy_data")
  constraints        Json?
  requirements       Json?
  budgetRange        Json?    @map("budget_range")
  status             String   @default("draft")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Relations
  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  devis Devis? @relation(fields: [devisId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([devisId])
  @@map("project_ccf")
}

// ============================================================================
// Chat Models
// ============================================================================

model ChatMessage {
  id               String   @id @default(uuid())
  devisId          String   @map("devis_id")
  userId           String   @map("user_id")
  role             String
  content          String
  metadata         Json?
  recommendationId String?  @map("recommendation_id")
  documentId       String?  @map("document_id")
  createdAt        DateTime @default(now()) @map("created_at")

  // Relations
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  devis Devis @relation(fields: [devisId], references: [id], onDelete: Cascade)

  @@index([devisId])
  @@index([userId])
  @@map("chat_messages")
}

// ============================================================================
// Complementary Documents Models
// ============================================================================

model ComplementaryDocument {
  id                 String   @id @default(uuid())
  devisId            String   @map("devis_id")
  userId             String   @map("user_id")
  recommendationId   String?  @map("recommendation_id")
  recommendationType String?  @map("recommendation_type")
  fileName           String   @map("file_name")
  fileType           String   @map("file_type")
  fileSize           Int      @map("file_size")
  fileUrl            String   @map("file_url")
  documentType       String?  @map("document_type")
  status             String   @default("pending")
  validationNotes    String?  @map("validation_notes")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Relations
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  devis Devis @relation(fields: [devisId], references: [id], onDelete: Cascade)

  @@index([devisId])
  @@index([userId])
  @@index([recommendationId])
  @@map("complementary_documents")
}

// ============================================================================
// Recommendation Feedback Models
// ============================================================================

model RecommendationFeedback {
  id               String   @id @default(uuid())
  devisId          String   @map("devis_id")
  userId           String   @map("user_id")
  recommendationId String   @map("recommendation_id")
  rating           Int?
  useful           Boolean?
  actionTaken      Boolean? @map("action_taken")
  feedbackText     String?  @map("feedback_text")
  documentsAdded   String[] @map("documents_added")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relations
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  devis Devis @relation(fields: [devisId], references: [id], onDelete: Cascade)

  @@unique([devisId, recommendationId])
  @@index([devisId])
  @@index([userId])
  @@map("recommendation_feedback")
}

// ============================================================================
// External Data Cache Models
// ============================================================================

model ExternalDataCache {
  id        String   @id @default(uuid())
  cacheKey  String   @unique @map("cache_key")
  dataType  String   @map("data_type")
  data      Json
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([cacheKey])
  @@index([expiresAt])
  @@map("external_data_cache")
}

// ============================================================================
// RNB (Référentiel National des Bâtiments) Models
// ============================================================================

model RNBBuilding {
  id          String  @id @default(uuid())
  rnbId       String? @unique @map("rnb_id") // Identifiant RNB original
  department  String // Code département (01-95, 971-978)
  codeINSEE   String? @map("code_insee")
  commune     String?
  address     String?
  postalCode  String? @map("postal_code")
  coordinates Json? // {lat, lng}

  // Données bâti
  constructionYear Int?    @map("construction_year")
  buildingType     String? @map("building_type")
  surface          Float? // Surface en m²

  // Données énergétiques
  dpeClass          String?   @map("dpe_class") // A-G, N/A
  dpeDate           DateTime? @map("dpe_date")
  energyConsumption Float?    @map("energy_consumption") // kWh/m²/an
  ghgEmissions      Float?    @map("ghg_emissions") // kg CO2/m²/an
  hvd               Boolean   @default(false) // Haute Valeur Déterminante

  // Métadonnées
  sourceUrl   String?  @map("source_url")
  indexedAt   DateTime @default(now()) @map("indexed_at")
  lastUpdated DateTime @updatedAt @map("last_updated")

  @@index([department])
  @@index([codeINSEE])
  @@index([postalCode])
  @@index([dpeClass])
  @@index([indexedAt])
  @@map("rnb_buildings")
}

model RNBImportJob {
  id            String          @id @default(uuid())
  department    String // Code département
  resourceId    String?         @map("resource_id") // ID ressource data.gouv.fr
  resourceUrl   String          @map("resource_url")
  status        RNBImportStatus @default(PENDING)
  progress      Float           @default(0) // 0-100
  totalRows     Int?            @map("total_rows")
  processedRows Int             @default(0) @map("processed_rows")
  errorMessage  String?         @map("error_message")
  startedAt     DateTime?       @map("started_at")
  completedAt   DateTime?       @map("completed_at")
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")

  @@index([department])
  @@index([status])
  @@index([createdAt])
  @@map("rnb_import_jobs")
}

// ============================================================================
// RGE (Reconnu Garant de l'Environnement) Models
// ============================================================================

model RGECertification {
  id          String  @id @default(uuid())
  siret       String  @unique // SIRET de l'entreprise (14 chiffres)
  siren       String // SIREN (9 premiers chiffres du SIRET)
  companyName String? @map("company_name")

  // Adresse
  address    String?
  postalCode String? @map("postal_code")
  city       String?
  department String? // Code département pour indexation
  region     String?

  // Certification
  certificationNumber String?   @map("certification_number")
  certificationDate   DateTime? @map("certification_date")
  expiryDate          DateTime? @map("expiry_date")
  isValid             Boolean   @default(true) @map("is_valid")

  // Domaines d'activité (JSON array)
  activities Json? // Array<{code: string, label: string, validUntil?: string}>

  // Métadonnées
  sourceUrl   String?  @map("source_url")
  indexedAt   DateTime @default(now()) @map("indexed_at")
  lastUpdated DateTime @updatedAt @map("last_updated")

  @@index([siret])
  @@index([siren])
  @@index([department])
  @@index([postalCode])
  @@index([isValid])
  @@index([indexedAt])
  @@map("rge_certifications")
}

model RGEImportJob {
  id             String          @id @default(uuid())
  resourceId     String?         @map("resource_id") // ID ressource data.gouv.fr
  resourceUrl    String          @map("resource_url")
  resourceTitle  String?         @map("resource_title")
  resourceFormat String?         @map("resource_format") // csv, json, etc.
  status         RGEImportStatus @default(PENDING)
  progress       Float           @default(0) // 0-100
  totalRows      Int?            @map("total_rows")
  processedRows  Int             @default(0) @map("processed_rows")
  errorMessage   String?         @map("error_message")
  startedAt      DateTime?       @map("started_at")
  completedAt    DateTime?       @map("completed_at")
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")

  @@index([status])
  @@index([createdAt])
  @@map("rge_import_jobs")
}

enum RGEImportStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
  CANCELLED

  @@map("rge_import_status")
}

enum RNBImportStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
  CANCELLED

  @@map("rnb_import_status")
}

// ============================================================================
// Base Adresse Nationale (BAN) - Indexation locale
// Dataset ID: 5530fbacc751df5ff937dddb
// ============================================================================

model BANAddress {
  id         String  @id @default(uuid())
  banId      String? @unique @map("ban_id") // Identifiant BAN original
  department String // Code département (01-95, 971-978)
  codeINSEE  String? @map("code_insee")
  commune    String?

  // Adresse complète
  formatted   String // Adresse formatée complète
  housenumber String? @map("house_number")
  street      String?
  postalCode  String  @map("postal_code")
  city        String
  region      String?
  country     String  @default("FR")

  // Coordonnées géographiques
  coordinates Json? // {lat, lng}

  // Données complémentaires BAN
  citycode String? // Code INSEE commune
  district String? // Arrondissement si applicable

  // Métadonnées
  sourceUrl   String?  @map("source_url")
  indexedAt   DateTime @default(now()) @map("indexed_at")
  lastUpdated DateTime @updatedAt @map("last_updated")

  @@index([department])
  @@index([codeINSEE])
  @@index([postalCode])
  @@index([city])
  @@index([formatted])
  @@index([indexedAt])
  @@map("ban_addresses")
}

model BANImportJob {
  id            String          @id @default(uuid())
  department    String // Code département
  resourceId    String?         @map("resource_id") // ID ressource data.gouv.fr
  resourceUrl   String          @map("resource_url")
  status        BANImportStatus @default(PENDING)
  progress      Float           @default(0) // 0-100
  totalRows     Int?            @map("total_rows")
  processedRows Int             @default(0) @map("processed_rows")
  errorMessage  String?         @map("error_message")
  startedAt     DateTime?       @map("started_at")
  completedAt   DateTime?       @map("completed_at")
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")

  @@index([department])
  @@index([status])
  @@index([createdAt])
  @@map("ban_import_jobs")
}

enum BANImportStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
  CANCELLED

  @@map("ban_import_status")
}

// ============================================================================
// Building Profile Models (Carte d'identité du logement)
// ============================================================================

model BuildingProfile {
  id     String  @id @default(uuid())
  userId String  @map("user_id")
  name   String? // Nom personnalisé (ex: "Maison principale", "Résidence secondaire")

  // Rôle et hiérarchie
  role            BuildingProfileRole @default(PROPRIETAIRE) // PROPRIETAIRE ou LOCATAIRE
  parentProfileId String?             @map("parent_profile_id") // ID de la carte propriétaire (si locataire)

  // Identification unique du bien
  address     Json // Données complètes d'adresse (AddressData)
  coordinates Json? // {lat, lng}

  // Données cadastrales
  cadastralData     Json?   @map("cadastral_data") // Données complètes cadastrales
  parcelleNumber    String? @map("parcelle_number") // Numéro parcelle
  sectionCadastrale String? @map("section_cadastrale")
  lotNumber         String? @map("lot_number") // Numéro de lot/appartement (pour différencier appartements sur même parcelle)
  codeINSEE         String? @map("code_insee")

  // Données enrichies automatiquement (uniquement pour carte propriétaire)
  enrichedData Json? @map("enriched_data") // AggregatedBuildingData
  pluData      Json? @map("plu_data")
  rnbData      Json? @map("rnb_data")
  dpeData      Json? @map("dpe_data")
  urbanismData Json? @map("urbanism_data")

  // Métadonnées enrichissement
  enrichmentStatus  String    @default("pending") @map("enrichment_status") // pending, in_progress, completed, failed
  enrichmentSources String[]  @map("enrichment_sources") // Liste des sources utilisées
  enrichmentErrors  Json?     @map("enrichment_errors")
  lastEnrichedAt    DateTime? @map("last_enriched_at")

  // Données complémentaires utilisateur
  customFields Json?   @map("custom_fields") // Champs personnalisables par l'utilisateur
  notes        String? // Notes libres

  // Données spécifiques locataire (entretien, maintenance, etc.)
  tenantData Json? @map("tenant_data") // Données spécifiques locataire (carnet d'entretien, travaux, etc.)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  buildingDocuments BuildingDocument[]
  parentProfile     BuildingProfile?   @relation("BuildingProfileHierarchy", fields: [parentProfileId], references: [id], onDelete: Cascade)
  tenantProfiles    BuildingProfile[]  @relation("BuildingProfileHierarchy")

  @@unique([parcelleNumber, sectionCadastrale, lotNumber, role], name: "unique_proprietaire_per_bien")
  @@index([userId])
  @@index([codeINSEE])
  @@index([parcelleNumber])
  @@index([parentProfileId])
  @@map("building_profiles")
}

enum BuildingProfileRole {
  PROPRIETAIRE // Carte propriétaire (unique par bien)
  LOCATAIRE // Sous-carte locataire (liée à une carte propriétaire)

  @@map("building_profile_role")
}

enum BuildingDocumentType {
  TITLE_DEED // Titre de propriété
  INSURANCE_HOME // Assurance habitation
  INSURANCE_LIFE // Assurance vie
  PROPERTY_TAX // Taxe foncière
  NOTARY_ACT // Acte notarié
  CONSTRUCTION_PERMIT // Permis de construire
  DPE_CERTIFICATE // Certificat DPE
  TECHNICAL_REPORT // Rapport technique
  WARRANTY // Garantie
  MAINTENANCE_LOG // Carnet d'entretien
  ENERGY_CERTIFICATE // Certificat énergétique
  RGE_CERTIFICATE // Certificat RGE
  OTHER // Autre

  @@map("building_document_type")
}

model BuildingDocument {
  id                String @id @default(uuid())
  buildingProfileId String @map("building_profile_id")
  userId            String @map("user_id")

  // Métadonnées fichier
  fileName String @map("file_name")
  fileType String @map("file_type")
  fileSize Int    @map("file_size")
  fileUrl  String @map("file_url")

  // Classification
  documentType     BuildingDocumentType @map("document_type")
  documentCategory String?              @map("document_category") // Propriété, Assurance, Fiscalité, etc.
  description      String? // Description libre

  // Métadonnées extraites (OCR)
  extractedData Json?          @map("extracted_data")
  ocrStatus     DocumentStatus @default(PENDING) @map("ocr_status")
  ocrData       Json?          @map("ocr_data")

  // Validation et tags
  isValidated Boolean  @default(false) @map("is_validated")
  tags        String[] // Tags personnalisés

  // Dates importantes
  documentDate   DateTime? @map("document_date") // Date du document (ex: date échéance assurance)
  expirationDate DateTime? @map("expiration_date") // Date d'expiration si applicable

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  buildingProfile BuildingProfile @relation(fields: [buildingProfileId], references: [id], onDelete: Cascade)

  @@index([buildingProfileId])
  @@index([userId])
  @@index([documentType])
  @@index([documentDate])
  @@index([expirationDate])
  @@map("building_documents")
}

// ============================================================================
// GPT Integration Models
// ============================================================================

model GPTApiKey {
  id          String    @id @default(uuid())
  name        String // Nom descriptif de la clé (ex: "Production GPT", "Test GPT")
  apiKey      String    @unique @map("api_key") // La clé API générée
  isActive    Boolean   @default(true) @map("is_active")
  lastUsedAt  DateTime? @map("last_used_at")
  usageCount  Int       @default(0) @map("usage_count")
  rateLimit   Int       @default(100) @map("rate_limit") // Limite par heure
  permissions Json      @default("{}") // Permissions spécifiques (lecture, écriture, etc.)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  expiresAt   DateTime? @map("expires_at") // Date d'expiration optionnelle

  // Relations
  gptAnalyses GPTAnalysis[]

  @@index([apiKey])
  @@index([isActive])
  @@index([createdAt])
  @@map("gpt_api_keys")
}

model GPTAnalysis {
  id          String   @id @default(uuid())
  devisId     String   @map("devis_id")
  apiKeyId    String   @map("api_key_id")

  // Score et évaluation du GPT
  gptScore       Decimal @map("gpt_score") @db.Decimal(5, 2) // Score sur 100 ou 1000
  gptGrade       String? @map("gpt_grade") // Grade A-E
  confidence     Decimal @default(0) @db.Decimal(5, 2) // Niveau de confiance 0-100

  // Analyse détaillée
  analysis       Json // Analyse complète du GPT
  recommendations Json // Recommandations
  alerts         Json? // Alertes identifiées
  strengths      Json? // Points forts identifiés
  weaknesses     Json? // Points faibles identifiés

  // Métadonnées
  processingTime Int?     @map("processing_time") // Temps de traitement en ms
  gptModel       String?  @map("gpt_model") // Modèle GPT utilisé (ex: "gpt-4", "gpt-4-turbo")
  version        String   @default("1.0.0") // Version de l'agent GPT
  metadata       Json?    // Métadonnées supplémentaires

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  devis  Devis     @relation(fields: [devisId], references: [id], onDelete: Cascade)
  apiKey GPTApiKey @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)

  @@index([devisId])
  @@index([apiKeyId])
  @@index([createdAt])
  @@map("gpt_analyses")
}

// Ajout de la relation dans le modèle Devis
// Note: Ajouter "gptAnalyses GPTAnalysis[]" dans le modèle Devis
